<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browse Projects - Projexia</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/projexia-design-system.css" />
    <link rel="stylesheet" href="/css/navbar-modern.css" />
    <link rel="stylesheet" href="/css/modal-modern.css" />
    <link rel="stylesheet" href="/css/footer-modern.css" />
    <link rel="stylesheet" href="/css/browse-projects.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet" />
    <script src="/js/theme.js"></script>
</head>
<body>
    <div class="min-h-screen flex flex-col">
      <!-- Navbar -->
      <%- include('partials/navbar-modern') %>
      
      <!-- Main Content -->
      <main style="flex: 1; padding-top: 4rem;">
        <!-- Browse Header -->
        <section class="browse-header">
          <div class="container">
            <h1 class="browse-title">Browse Projects</h1>
            <p class="browse-subtitle">Discover and explore amazing projects from your fellow CCS students</p>
          </div>
        </section>

        <!-- Filters & Search -->
        <section class="browse-controls">
          <div class="container">
            <!-- Sort Dropdown -->
            <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
              <h2 style="font-size: 1.5rem; font-weight: 600; color: hsl(var(--foreground));">Browse Projects</h2>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <label for="sortFilter" style="color: hsl(var(--muted-foreground)); font-size: 0.9rem;">Sort by:</label>
                <select class="input" id="sortFilter" style="width: auto; min-width: 150px;">
                  <option value="trending" <%= selectedSort === 'trending' ? 'selected' : '' %>>üî• Trending</option>
                  <option value="newest" <%= selectedSort === 'newest' ? 'selected' : '' %>>üÜï Newest</option>
                  <option value="likes" <%= selectedSort === 'likes' ? 'selected' : '' %>>‚ù§Ô∏è Most Liked</option>
                  <option value="views" <%= selectedSort === 'views' ? 'selected' : '' %>>üëÅÔ∏è Most Viewed</option>
                  <option value="random" <%= selectedSort === 'random' ? 'selected' : '' %>>üé≤ Random</option>
                </select>
              </div>
            </div>
            
            <div class="filters-grid">
              <!-- Search -->
              <div class="search-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input 
                  type="text" 
                  class="input search-input" 
                  placeholder="Search projects by name, technology, or keyword..."
                  id="searchInput"
                />
              </div>

              <!-- Program Filter -->
              <select class="input" id="programFilter">
                <option value="">All Programs</option>
                <option value="BSCS" <%= selectedProgram === 'BSCS' ? 'selected' : '' %>>BS Computer Science</option>
                <option value="BSIT" <%= selectedProgram === 'BSIT' ? 'selected' : '' %>>BS Information Technology</option>
                <option value="BSIS" <%= selectedProgram === 'BSIS' ? 'selected' : '' %>>BS Information Systems</option>
              </select>

              <!-- Year Filter -->
              <select class="input" id="yearFilter">
                <option value="">All Years</option>
                <option value="1" <%= selectedYear === '1' ? 'selected' : '' %>>1st Year</option>
                <option value="2" <%= selectedYear === '2' ? 'selected' : '' %>>2nd Year</option>
                <option value="3" <%= selectedYear === '3' ? 'selected' : '' %>>3rd Year</option>
                <option value="4" <%= selectedYear === '4' ? 'selected' : '' %>>4th Year</option>
              </select>

              <!-- Track Filter (only show for 3rd and 4th year with BSIT or BSCS) -->
              <select class="input" id="trackFilter" style="display: none;">
                <option value="">All Tracks</option>
                <!-- BSIT Tracks -->
                <option value="WMAD" data-program="BSIT" <%= selectedTrack === 'WMAD' ? 'selected' : '' %>>WMAD</option>
                <option value="AMG" data-program="BSIT" <%= selectedTrack === 'AMG' ? 'selected' : '' %>>AMG</option>
                <option value="SMP" data-program="BSIT" <%= selectedTrack === 'SMP' ? 'selected' : '' %>>SMP</option>
                <option value="NETAD" data-program="BSIT" <%= selectedTrack === 'NETAD' ? 'selected' : '' %>>NETAD</option>
                <!-- BSCS Tracks -->
                <option value="IS" data-program="BSCS" <%= selectedTrack === 'IS' ? 'selected' : '' %>>IS</option>
                <option value="GV" data-program="BSCS" <%= selectedTrack === 'GV' ? 'selected' : '' %>>GV</option>
              </select>

              <!-- Technology Filter (Multi-select) -->
              <div class="tech-filter-wrapper" style="position: relative;">
                <button type="button" class="input tech-filter-button" id="techFilterButton" style="text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                  <span id="techFilterLabel">All Technologies</span>
                  <svg style="width: 1rem; height: 1rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
                <div class="tech-filter-dropdown" id="techFilterDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: 0.5rem; margin-top: 0.25rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                  <div style="padding: 0.5rem;">
                    <label style="display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 0.25rem;" onmouseover="this.style.background='hsl(var(--accent))'" onmouseout="this.style.background=''">
                      <input type="checkbox" value="" id="techAll" style="margin-right: 0.5rem;" checked>
                      <span>All Technologies</span>
                    </label>
                    <% if (availableTechnologies && availableTechnologies.length > 0) { %>
                      <% availableTechnologies.forEach(tech => { %>
                        <label style="display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 0.25rem;" onmouseover="this.style.background='hsl(var(--accent))'" onmouseout="this.style.background=''">
                          <input type="checkbox" class="tech-checkbox" value="<%= tech %>" style="margin-right: 0.5rem;">
                          <span><%= tech %></span>
                        </label>
                      <% }); %>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Clear Filters Button -->
            <% if (searchTerm || selectedProgram || selectedYear || selectedTrack || (selectedLanguages && selectedLanguages.length > 0)) { %>
              <div style="margin-top: 1rem; text-align: center;">
                <button onclick="window.location.href='/browse'" class="btn btn-outline" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                  <svg style="width: 1rem; height: 1rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                  Clear All Filters
                </button>
              </div>
            <% } %>
          </div>
        </section>

        <!-- Projects Grid -->
        <section class="browse-projects">
          <div class="container">
            <!-- Results Count -->
            <div style="margin-bottom: 1.5rem; color: hsl(var(--muted-foreground)); font-size: 0.95rem;">
              <% if (projects && projects.length > 0) { %>
                Showing <strong style="color: hsl(var(--foreground));"><%= projects.length %></strong> project<%= projects.length !== 1 ? 's' : '' %>
                <% if (searchTerm || selectedProgram || selectedYear || selectedTrack || (selectedLanguages && selectedLanguages.length > 0)) { %>
                  matching your filters
                <% } %>
              <% } %>
            </div>
            
            <div id="projectsContainer" class="projects-grid">
              <!-- Projects will be loaded here -->
              <% if (projects && projects.length > 0) { %>
                <% projects.forEach(project => { %>
                  <a href="/project/<%= project._id %>" class="project-card-link" style="text-decoration: none; color: inherit;">
                    <div class="project-card">
                      <div class="project-image">
                        <img src="<%= project.thumbnailUrl?.url || '/images/default-project.png' %>" alt="<%= project.name %>" />
                      </div>
                      <div class="project-content">
                        <!-- Title -->
                        <h3 class="project-title"><%= project.name %></h3>
                        
                        <!-- Author Info -->
                        <div class="project-author-info">
                          <span class="author-name"><%= project.userId?.fullName || 'Author' %></span>
                        </div>
                        
                        <!-- Technologies -->
                        <% if (project.technologies && project.technologies.length > 0) { %>
                          <div class="tech-tags">
                            <% project.technologies.slice(0, 4).forEach(tech => { %>
                              <span class="tech-tag"><%= tech %></span>
                            <% }) %>
                            <% if (project.technologies.length > 4) { %>
                              <span class="tech-tag">+<%= project.technologies.length - 4 %></span>
                            <% } %>
                          </div>
                        <% } %>
                        
                        <!-- Stats -->
                        <div class="project-stats">
                          <div class="project-stat">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            <span><%= project.likes || 0 %></span>
                          </div>
                          <div class="project-stat">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span><%= project.comments || 0 %></span>
                          </div>
                          <div class="project-stat">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                              <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <span><%= project.viewCount || 0 %></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </a>
                <% }); %>
              <% } else { %>
                <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                  <svg style="width: 4rem; height: 4rem; margin: 0 auto 1rem; color: hsl(var(--muted-foreground));" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                  <h3 style="font-size: 1.25rem; color: hsl(var(--foreground)); margin-bottom: 0.5rem;">No projects found</h3>
                  <p style="color: hsl(var(--muted-foreground));">Try adjusting your filters or search terms</p>
                </div>
              <% } %>
            </div>
          </div>
        </section>
      </main>
      
      <!-- Footer -->
      <%- include('partials/footer-modern') %>
    </div>

    <script>
      // Filter functionality - use server-side filtering with URL parameters
      const searchInput = document.getElementById('searchInput');
      const programFilter = document.getElementById('programFilter');
      const yearFilter = document.getElementById('yearFilter');
      const trackFilter = document.getElementById('trackFilter');
      const sortFilter = document.getElementById('sortFilter');
      const techFilterButton = document.getElementById('techFilterButton');
      const techFilterDropdown = document.getElementById('techFilterDropdown');
      const techFilterLabel = document.getElementById('techFilterLabel');
      const techAllCheckbox = document.getElementById('techAll');
      const techCheckboxes = document.querySelectorAll('.tech-checkbox');

      // Set initial values from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      searchInput.value = urlParams.get('search') || '';
      programFilter.value = urlParams.get('program') || '';
      yearFilter.value = urlParams.get('yearLevel') || '';
      trackFilter.value = urlParams.get('track') || '';
      
      // Handle multiple technologies from server
      const selectedTechs = <%- JSON.stringify(selectedLanguages || []) %>;
      if (selectedTechs.length > 0) {
        techCheckboxes.forEach(checkbox => {
          if (selectedTechs.includes(checkbox.value)) {
            checkbox.checked = true;
          }
        });
        techAllCheckbox.checked = false;
        updateTechFilterLabel();
      }

      // Toggle technology filter dropdown
      techFilterButton.addEventListener('click', (e) => {
        e.stopPropagation();
        techFilterDropdown.style.display = techFilterDropdown.style.display === 'none' ? 'block' : 'none';
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!techFilterButton.contains(e.target) && !techFilterDropdown.contains(e.target)) {
          techFilterDropdown.style.display = 'none';
        }
      });

      // Handle "All Technologies" checkbox
      techAllCheckbox.addEventListener('change', () => {
        if (techAllCheckbox.checked) {
          techCheckboxes.forEach(cb => cb.checked = false);
          updateTechFilterLabel();
          applyFilters();
        }
      });

      // Handle individual technology checkboxes
      techCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            techAllCheckbox.checked = false;
          }
          
          // If no checkboxes are selected, check "All"
          const anyChecked = Array.from(techCheckboxes).some(cb => cb.checked);
          if (!anyChecked) {
            techAllCheckbox.checked = true;
          }
          
          updateTechFilterLabel();
          applyFilters();
        });
      });

      // Update the label to show selected technologies
      function updateTechFilterLabel() {
        const selected = Array.from(techCheckboxes).filter(cb => cb.checked);
        if (selected.length === 0) {
          techFilterLabel.textContent = 'All Technologies';
        } else if (selected.length === 1) {
          techFilterLabel.textContent = selected[0].value;
        } else {
          techFilterLabel.textContent = `${selected.length} Technologies`;
        }
      }

      // Show/hide track filter based on year and program selection
      function updateTrackFilterVisibility() {
        const year = yearFilter.value;
        const program = programFilter.value;
        
        // Show track filter for BSIT or BSCS programs (regardless of year)
        // This allows filtering all projects from a specific track (both 3rd and 4th year)
        const shouldShowTrack = (program === 'BSIT' || program === 'BSCS');
        
        if (shouldShowTrack) {
          trackFilter.style.display = '';
          
          // Show/hide options based on selected program
          const options = trackFilter.querySelectorAll('option[data-program]');
          options.forEach(option => {
            const optionProgram = option.getAttribute('data-program');
            if (optionProgram === program) {
              option.style.display = '';
            } else {
              option.style.display = 'none';
            }
          });
          
          // Reset track if current selection doesn't match program
          const selectedOption = trackFilter.options[trackFilter.selectedIndex];
          if (selectedOption && selectedOption.getAttribute('data-program') !== program && selectedOption.value !== '') {
            trackFilter.value = '';
          }
        } else {
          trackFilter.style.display = 'none';
          trackFilter.value = ''; // Reset track when hidden
        }
      }

      // Update visibility on page load
      updateTrackFilterVisibility();

      function applyFilters() {
        const params = new URLSearchParams();
        
        const search = searchInput.value.trim();
        const program = programFilter.value;
        const year = yearFilter.value;
        const track = trackFilter.value;
        const sort = sortFilter.value;
        
        // Get selected technologies
        const selectedTechnologies = Array.from(techCheckboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);

        if (search) params.set('search', search);
        if (program) params.set('program', program);
        if (year) params.set('yearLevel', year);
        if (track) params.set('track', track);
        if (sort && sort !== 'trending') params.set('sort', sort); // Default is trending
        
        // Add multiple language parameters
        selectedTechnologies.forEach(tech => {
          params.append('language', tech);
        });

        // Reload page with new parameters
        window.location.href = '/browse' + (params.toString() ? '?' + params.toString() : '');
      }

      // Apply filters on change
      programFilter.addEventListener('change', () => {
        updateTrackFilterVisibility();
        applyFilters();
      });
      yearFilter.addEventListener('change', () => {
        updateTrackFilterVisibility();
        applyFilters();
      });
      trackFilter.addEventListener('change', applyFilters);
      sortFilter.addEventListener('change', applyFilters);

      // Apply search on Enter key or after typing stops
      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 500); // Wait 500ms after user stops typing
      });

      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          clearTimeout(searchTimeout);
          applyFilters();
        }
      });
    </script>
    
    <!-- Modal System -->
    <script src="/js/modal.js"></script>
    
    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Notifications System -->
    <script src="/js/notifications.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= project.title %> - Projexia</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/projexia-design-system.css" />
    <link rel="stylesheet" href="/css/navbar-modern.css" />
    <link rel="stylesheet" href="/css/modal-modern.css" />
    <link rel="stylesheet" href="/css/footer-modern.css" />
    <link rel="stylesheet" href="/css/project-detail.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet" />
    <script src="/js/theme.js"></script>
</head>
<body>
    <div class="min-h-screen flex flex-col">
      <!-- Navbar -->
      <%- include('partials/navbar-modern') %>
      
      <!-- Main Content -->
      <main style="flex: 1; padding-top: 4rem;">
        <div class="project-detail-container">
          <div class="container">
            

            <div class="project-detail-grid">
              <!-- Main Content -->
              <div class="project-detail-main">
                <!-- Project Header -->
                <div class="project-detail-header">
                  <div class="project-detail-image" onclick="openImageZoom(this.querySelector('img').src)">
                    <img src="<%= project.thumbnailUrl?.url || '/images/default-project.png' %>" alt="<%= project.name %>" style="cursor: pointer;">
                  </div>

                  <div class="project-detail-info">
                    <div class="project-badges">
                      <% if (project.program) { %>
                        <span class="badge badge-primary"><%= project.program %></span>
                      <% } %>
                      <% if (project.yearLevel) { %>
                        <span class="badge">Year <%= project.yearLevel %></span>
                      <% } %>
                      <% if (project.status) { %>
                        <span class="badge" style="background-color: hsl(var(--secondary) / 0.1); color: hsl(var(--secondary));">
                          <%= project.status %>
                        </span>
                      <% } %>
                    </div>

                    <h1 class="project-detail-title"><%= project.name %></h1>

                    <div class="project-author-section">
                      <div class="author-card">
                        <div class="author-avatar-large">
                          <%= project.userId?.fullName?.charAt(0) || '?' %>
                        </div>
                        <div>
                          <p class="author-name-large"><%= project.userId?.fullName || 'Anonymous' %></p>
                          <p class="author-role"><%= project.userId?.program || 'CCS Student' %></p>
                          <p class="author-date">Published <%= new Date(project.createdAt).toLocaleDateString() %></p>
                        </div>
                      </div>
                    </div>

                    <div class="project-stats-section">
                      <div class="stat-item">
                        <div class="stat-icon">
                          <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                          </svg>
                        </div>
                        <div>
                          <p class="stat-value"><%= project.likes || 0 %></p>
                          <p class="stat-label">Likes</p>
                        </div>
                      </div>
                      <div class="stat-item">
                        <div class="stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                          </svg>
                        </div>
                        <div>
                          <p class="stat-value"><%= project.comments?.length || 0 %></p>
                          <p class="stat-label">Comments</p>
                        </div>
                      </div>
                      <div class="stat-item">
                        <div class="stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                        </div>
                        <div>
                          <p class="stat-value"><%= project.views || 0 %></p>
                          <p class="stat-label">Views</p>
                        </div>
                      </div>
                    </div>

                    <div class="project-actions">
                      <button class="btn btn-primary btn-lg" id="likeBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        Like This Project
                      </button>
                      <% if (project.sourceCode) { %>
                        <a href="<%= project.sourceCode %>" target="_blank" class="btn btn-outline btn-lg">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="12 3 20 7.5 20 16.5 12 21 4 16.5 4 7.5 12 3"></polyline>
                            <line x1="12" y1="12" x2="20" y2="7.5"></line>
                            <line x1="12" y1="12" x2="12" y2="21"></line>
                            <line x1="12" y1="12" x2="4" y2="7.5"></line>
                          </svg>
                          View Source Code
                        </a>
                      <% } %>
                    </div>
                  </div>
                </div>

                <!-- Project Description -->
                <div class="project-section">
                  <h2 class="section-title">About This Project</h2>
                  <div class="project-description-full">
                    <%= project.description %>
                  </div>
                </div>

                <!-- Technologies -->
                <% if (project.technologies && project.technologies.length > 0) { %>
                  <div class="project-section">
                    <h2 class="section-title">Technologies Used</h2>
                    <div class="tech-list">
                      <% project.technologies.forEach(tech => { %>
                        <span class="tech-badge"><%= tech %></span>
                      <% }); %>
                    </div>
                  </div>
                <% } %>

                <!-- Developers/Team Members -->
                <% if (project.developers && project.developers.length > 0) { %>
                  <div class="project-section">
                    <h2 class="section-title">Team Members</h2>
                    <div class="developers-list">
                      <% project.developers.forEach(dev => { %>
                        <div class="developer-item">
                          <div class="developer-avatar"><%= dev.charAt(0).toUpperCase() %></div>
                          <span><%= dev %></span>
                        </div>
                      <% }); %>
                    </div>
                  </div>
                <% } %>

                <!-- Project Links -->
                <% if (project.githubLink || project.websiteLink) { %>
                  <div class="project-section">
                    <h2 class="section-title">Project Links</h2>
                    <div class="project-links">
                      <% if (project.githubLink) { %>
                        <a href="<%= project.githubLink %>" target="_blank" rel="noopener noreferrer" class="btn btn-outline">
                          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20" style="margin-right: 0.5rem;">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                          </svg>
                          GitHub Repository
                        </a>
                      <% } %>
                      <% if (project.websiteLink) { %>
                        <a href="<%= project.websiteLink %>" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="margin-right: 0.5rem;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            <path d="M2 12h20"></path>
                          </svg>
                          Live Demo
                        </a>
                      <% } %>
                    </div>
                  </div>
                <% } %>

                <!-- Project Gallery -->
                <% if (project.otherImages && project.otherImages.length > 0) { %>
                  <div class="project-section">
                    <h2 class="section-title">Project Gallery</h2>
                    <div class="project-gallery">
                      <% project.otherImages.forEach((img, index) => { %>
                        <div class="gallery-item" onclick="openImageZoom('<%= img.url %>')">
                          <img src="<%= img.url %>" alt="Project image <%= index + 1 %>" style="cursor: pointer;">
                        </div>
                      <% }); %>
                    </div>
                  </div>
                <% } %>

                <!-- Features -->
                <% if (project.features && project.features.length > 0) { %>
                  <div class="project-section">
                    <h2 class="section-title">Key Features</h2>
                    <ul class="features-list">
                      <% project.features.forEach(feature => { %>
                        <li><%= feature %></li>
                      <% }); %>
                    </ul>
                  </div>
                <% } %>

                <!-- Comments Section -->
                <div class="project-section comments-section">
                  <h2 class="section-title">Comments (<%= project.comments?.length || 0 %>)</h2>
                  
                  <!-- Add Comment Form -->
                  <% if (user) { %>
                    <div class="comment-form">
                      <div class="comment-avatar">
                        <%= user.name?.charAt(0) || '?' %>
                      </div>
                      <div style="flex: 1;">
                        <textarea 
                          class="input" 
                          placeholder="Share your thoughts..." 
                          rows="3"
                          id="commentInput"
                        ></textarea>
                        <button class="btn btn-primary" style="margin-top: 0.5rem;" id="submitCommentBtn">Post Comment</button>
                      </div>
                    </div>
                  <% } else { %>
                    <div class="comment-signin">
                      <p>Sign in to leave a comment</p>
                      <a href="/signin" class="btn btn-primary">Sign In</a>
                    </div>
                  <% } %>

                  <!-- Comments List -->
                  <div class="comments-list" id="commentsList">
                    <% if (comments && comments.length > 0) { %>
                      <% comments.forEach(comment => { %>
                        <div class="comment-item" data-comment-id="<%= comment._id %>">
                          <div class="comment-avatar">
                            <%= comment.userId?.fullName?.charAt(0) || '?' %>
                          </div>
                          <div class="comment-content">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                              <div>
                                <p class="comment-author"><%= comment.userId?.fullName || 'Anonymous' %></p>
                                <p class="comment-date"><%= new Date(comment.createdAt).toLocaleDateString() %></p>
                              </div>
                              <% if (user && (user._id.toString() === comment.userId?._id.toString() || user._id.toString() === project.userId?._id.toString())) { %>
                                <button class="comment-delete-btn" onclick="deleteComment('<%= project._id %>', '<%= comment._id %>')">×</button>
                              <% } %>
                            </div>
                            <p class="comment-text"><%= comment.text %></p>
                            
                            <!-- Replies Section -->
                            <% if (comment.replies && comment.replies.length > 0) { %>
                              <div class="replies-section">
                                <% comment.replies.forEach(reply => { %>
                                  <div class="reply-item">
                                    <div class="reply-avatar">
                                      <%= reply.userId?.fullName?.charAt(0) || '?' %>
                                    </div>
                                    <div class="reply-content">
                                      <p class="reply-author"><%= reply.userId?.fullName || 'Anonymous' %></p>
                                      <p class="reply-date"><%= new Date(reply.createdAt).toLocaleDateString() %></p>
                                      <p class="reply-text"><%= reply.text %></p>
                                    </div>
                                  </div>
                                <% }); %>
                              </div>
                            <% } %>
                            
                            <!-- Reply Button -->
                            <% if (user) { %>
                              <button class="reply-toggle-btn" onclick="toggleReplyForm('<%= comment._id %>')">Reply</button>
                            <% } %>
                            
                            <!-- Reply Form -->
                            <div class="reply-form-container" id="reply-form-<%= comment._id %>" style="display: none; margin-top: 1rem;">
                              <div class="reply-form">
                                <textarea 
                                  class="input" 
                                  placeholder="Write a reply..." 
                                  rows="2"
                                  id="replyInput-<%= comment._id %>"
                                ></textarea>
                                <div style="margin-top: 0.5rem;">
                                  <button class="btn btn-sm btn-primary" onclick="submitReply('<%= project._id %>', '<%= comment._id %>')">Post Reply</button>
                                  <button class="btn btn-sm btn-outline" onclick="toggleReplyForm('<%= comment._id %>')">Cancel</button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    <% } else { %>
                      <p style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">
                        No comments yet. Be the first to share your thoughts!
                      </p>
                    <% } %>
                  </div>
                </div>
              </div>

              <!-- Sidebar -->
              <aside class="project-sidebar">
                <!-- Project Info Card -->
                <div class="info-card">
                  <h3>Project Information</h3>
                  <div class="info-item">
                    <p class="info-label">Program</p>
                    <p class="info-value"><%= project.program || 'N/A' %></p>
                  </div>
                  <div class="info-item">
                    <p class="info-label">Year Level</p>
                    <p class="info-value">Year <%= project.yearLevel || 'N/A' %></p>
                  </div>
                  <div class="info-item">
                    <p class="info-label">Posted</p>
                    <p class="info-value"><%= new Date(project.createdAt).toLocaleDateString() %></p>
                  </div>
                </div>

                <!-- Share Card -->
                <div class="info-card">
                  <h3>Share This Project</h3>
                  <div class="share-buttons">
                    <button class="share-btn" onclick="shareProject('facebook')">
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                      </svg>
                    </button>
                    <button class="share-btn" onclick="shareProject('twitter')">
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M23.953 4.57a10 10 0 002.856-3.946 10 10 0 01-2.856.974 5 5 0 00-8.667 4.563 14 14 0 01-10.277-5.287 5 5 0 001.549 6.687 5 5 0 01-2.267-.616v.06a5 5 0 014.008 4.906 5 5 0 01-2.212.196 5 5 0 004.674 3.474 10 10 0 01-6.206 2.143 14 14 0 0010.227-2.833 13.995 13.995 0 0010.227-10.227c0-.212-.005-.423-.015-.634A10 10 0 0023.953 4.57z"/>
                      </svg>
                    </button>
                    <button class="share-btn" onclick="shareProject('linkedin')">
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <!-- Related Projects -->
                <div class="info-card">
                  <h3>More from <%= project.userId?.fullName || 'Author' %></h3>
                  <div class="related-projects">
                    <!-- Related projects would be loaded here -->
                    <p style="text-align: center; color: hsl(var(--muted-foreground)); padding: 1rem;">
                      <a href="/profile/<%= project.userId?._id %>" class="btn btn-outline" style="display: inline-block; margin-top: 0.5rem;">
                        View <%= project.userId?.fullName?.split(' ')[0] %>'s Portfolio →
                      </a>
                    </p>
                  </div>
                </div>
              </aside>
            </div>
          </div>
        </div>
      </main>
      
      <!-- Footer -->
      <%- include('partials/footer-modern') %>
    </div>

    <script>
      // ========================================
      // LIKE BUTTON FUNCTIONALITY
      // ========================================
      const likeBtn = document.getElementById('likeBtn');
      let isLiked = <%= isLiked || false %>;
      
      if (likeBtn) {
        // Update button UI based on initial state
        function updateLikeButton(liked, count) {
          const likeCountSpan = likeBtn.parentElement.parentElement.querySelector('.stat-value');
          if (liked) {
            likeBtn.classList.add('liked');
            likeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> Liked This Project';
          } else {
            likeBtn.classList.remove('liked');
            likeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> Like This Project';
          }
          if (likeCountSpan) {
            likeCountSpan.textContent = count;
          }
        }

        // Set initial state
        if (isLiked) {
          updateLikeButton(true, <%= project.likes %>);
        }

        likeBtn.addEventListener('click', async function() {
          try {
            const response = await fetch('/api/projects/<%= project._id %>/like', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
              const data = await response.json();
              isLiked = data.liked;
              updateLikeButton(data.liked, data.likeCount);
            } else if (response.status === 401) {
              await Modal.warning('Please sign in to like this project', 'Sign In Required');
              window.location.href = '/signin';
            }
          } catch (error) {
            console.error('Error liking project:', error);
            await Modal.error('Failed to like project', 'Error');
          }
        });
      }

      // ========================================
      // COMMENT SUBMISSION
      // ========================================
      const submitCommentBtn = document.getElementById('submitCommentBtn');
      const commentInput = document.getElementById('commentInput');
      
      if (submitCommentBtn && commentInput) {
        submitCommentBtn.addEventListener('click', submitComment);
        commentInput.addEventListener('keydown', function(e) {
          if (e.ctrlKey && e.key === 'Enter') {
            submitComment();
          }
        });
      }

      async function submitComment() {
        const text = commentInput.value.trim();
        if (!text) {
          await Modal.warning('Please enter a comment', 'Comment Required');
          return;
        }

        try {
          const response = await fetch('/api/projects/<%= project._id %>/comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              commentInput.value = '';
              addCommentToDOM(data.comment);
              updateCommentCount(data.commentCount);
            }
          } else if (response.status === 401) {
            await Modal.warning('Please sign in to comment', 'Sign In Required');
            window.location.href = '/signin';
          } else {
            const error = await response.json();
            await Modal.error(error.error || 'Failed to post comment', 'Error');
          }
        } catch (error) {
          console.error('Error posting comment:', error);
          await Modal.error('Failed to post comment', 'Error');
        }
      }

      function addCommentToDOM(comment) {
        const commentsList = document.getElementById('commentsList');
        
        // If no comments exist, clear the "no comments" message
        const noCommentsMsg = commentsList.querySelector('p');
        if (noCommentsMsg && noCommentsMsg.textContent.includes('No comments')) {
          noCommentsMsg.remove();
        }

        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment-item';
        commentDiv.setAttribute('data-comment-id', comment._id);
        commentDiv.innerHTML = `
          <div class="comment-avatar">
            ${comment.userId?.fullName?.charAt(0) || '?'}
          </div>
          <div class="comment-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <p class="comment-author">${comment.userId?.fullName || 'Anonymous'}</p>
                <p class="comment-date">${new Date(comment.createdAt).toLocaleDateString()}</p>
              </div>
              <button class="comment-delete-btn" onclick="deleteComment('<%= project._id %>', '${comment._id}')">×</button>
            </div>
            <p class="comment-text">${comment.text}</p>
          </div>
        `;
        
        commentsList.prepend(commentDiv);
      }

      function updateCommentCount(count) {
        const commentCountSpan = document.querySelector('.comments-section .section-title');
        if (commentCountSpan) {
          commentCountSpan.textContent = `Comments (${count})`;
        }
      }

      async function deleteComment(projectId, commentId) {
        const confirmed = await Modal.confirm('Delete this comment?', 'Confirm', 'Delete', 'Cancel');
        if (!confirmed) return;

        try {
          const response = await fetch(`/api/projects/${projectId}/comment/${commentId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            const data = await response.json();
            // Remove comment from DOM
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (commentElement) {
              commentElement.remove();
            }
            updateCommentCount(data.commentCount);
          } else if (response.status === 403) {
            await Modal.error('You are not authorized to delete this comment', 'Error');
          } else {
            await Modal.error('Failed to delete comment', 'Error');
          }
        } catch (error) {
          console.error('Error deleting comment:', error);
          await Modal.error('Failed to delete comment', 'Error');
        }
      }

      // ========================================
      // SHARE FUNCTIONALITY
      // ========================================
      function shareProject(platform) {
        const url = window.location.href;
        const title = '<%= project.name %>';
        let shareUrl;

        switch(platform) {
          case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            break;
          case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
            break;
          case 'linkedin':
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
            break;
        }

        if (shareUrl) {
          window.open(shareUrl, '_blank', 'width=600,height=400');
        }
      }

      // ========================================
      // IMAGE ZOOM MODAL
      // ========================================
      function openImageZoom(imageSrc) {
        let modal = document.getElementById('imageZoomModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'imageZoomModal';
          modal.className = 'image-modal';
          modal.innerHTML = `
            <div class="image-modal-content">
              <button class="image-modal-close" onclick="closeImageZoom()">×</button>
              <img id="zoomedImage" src="" alt="Zoomed image">
            </div>
          `;
          document.body.appendChild(modal);
          
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              closeImageZoom();
            }
          });
          
          document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              closeImageZoom();
            }
          });
        }
        
        document.getElementById('zoomedImage').src = imageSrc;
        modal.classList.add('active');
      }

      function closeImageZoom() {
        const modal = document.getElementById('imageZoomModal');
        if (modal) {
          modal.classList.remove('active');
        }
      }

      // ========================================
      // REPLY FUNCTIONALITY
      // ========================================
      function toggleReplyForm(commentId) {
        const replyFormContainer = document.getElementById(`reply-form-${commentId}`);
        if (replyFormContainer.style.display === 'none') {
          replyFormContainer.style.display = 'block';
          document.getElementById(`replyInput-${commentId}`).focus();
        } else {
          replyFormContainer.style.display = 'none';
        }
      }

      async function submitReply(projectId, commentId) {
        const replyText = document.getElementById(`replyInput-${commentId}`).value.trim();
        if (!replyText) {
          await Modal.warning('Please enter a reply', 'Reply Required');
          return;
        }

        try {
          const response = await fetch(`/api/projects/${projectId}/comment/${commentId}/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: replyText })
          });
          
          if (response.ok) {
            const data = await response.json();
            addReplyToDOM(commentId, data.reply);
            document.getElementById(`replyInput-${commentId}`).value = '';
            document.getElementById(`reply-form-${commentId}`).style.display = 'none';
          } else if (response.status === 401) {
            await Modal.warning('Please sign in to reply', 'Sign In Required');
            window.location.href = '/signin';
          } else {
            const error = await response.json();
            await Modal.error(error.error || 'Failed to post reply', 'Error');
          }
        } catch (error) {
          console.error('Error posting reply:', error);
          await Modal.error('Failed to post reply', 'Error');
        }
      }

      function addReplyToDOM(commentId, reply) {
        let repliesSection = document.querySelector(`[data-comment-id="${commentId}"] .replies-section`);
        
        // Create replies section if it doesn't exist
        if (!repliesSection) {
          const commentContent = document.querySelector(`[data-comment-id="${commentId}"] .comment-content`);
          repliesSection = document.createElement('div');
          repliesSection.className = 'replies-section';
          commentContent.insertBefore(repliesSection, commentContent.querySelector('.reply-toggle-btn'));
        }

        const replyDiv = document.createElement('div');
        replyDiv.className = 'reply-item';
        replyDiv.innerHTML = `
          <div class="reply-avatar">
            ${reply.userId?.fullName?.charAt(0) || '?'}
          </div>
          <div class="reply-content">
            <p class="reply-author">${reply.userId?.fullName || 'Anonymous'}</p>
            <p class="reply-date">${new Date(reply.createdAt).toLocaleDateString()}</p>
            <p class="reply-text">${reply.text}</p>
          </div>
        `;
        
        repliesSection.appendChild(replyDiv);
      }
    </script>
    
    <!-- Modal System -->
    <script src="/js/modal.js"></script>
    
    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Notifications System -->
    <script src="/js/notifications.js"></script>
</body>
</html>
